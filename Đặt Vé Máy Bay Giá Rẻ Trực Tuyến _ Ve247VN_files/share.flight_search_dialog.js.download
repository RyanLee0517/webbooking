Define("share.flight_search_dialog", {
    isLoading: false,
    enableShowLowestPriceOnSearchBox: false,
    validatesentmail: function () {
        var isValidEmail = true;
        var email = $('#emailCustomer').val();
        if (email == undefined || email == '' || (email != '' && !share.flight_search_dialog.isValidEmailCustom(email))) {
            isValidEmail = false;
        }
        return isValidEmail;
    },

    isValidEmailCustom: function (email) {
        // var re = /^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
        var re = /^[_a-z0-9-]+(\.[_a-z0-9-]+)*@[a-z0-9-]+(\.[a-z0-9-]+)*(\.[a-z]{2,4})$/;
        return re.test(email);
    },

    /*
    *
    * This function support switch DepartureCity and ArrivalCity
    *
    */
    switchLocations: function () {
        var departureCity = $('#DepartureCity').val();
        $('#DepartureCity').val($('#ArrivalCity').val());
        $('#ArrivalCity').val(departureCity);

        var departureCityCountry = $('#DepartureCityCountry').val();
        $('#DepartureCityCountry').val($('#ArrivalCityCountry').val());
        $('#ArrivalCityCountry').val(departureCityCountry);
        $('#departure-country').val($('#ArrivalCityCountry').val());
        $('#arrival-counry').val(departureCityCountry);

        departureCityName = $('#DepartureCity-Holder').val();
        $('#DepartureCity-Holder').val($('#ArrivalCity-Holder').val());
        $('#ArrivalCity-Holder').val(departureCityName);
    },

    /*
    *
    * This function support updatePaxInfo
    *
    */
    updatePaxInfo: function () {
       
        var adultNo = $('[name="AdultNo"]').val();
        var childNo = $('[name="ChildNo"]').val();
        var infantNo = $('[name="InfantNo"]').val();


        if ($('#viewPassengerInfoContent #adultLabel').length <= 0) {
            var html = adultNo + ' người lớn, ' + childNo + ' trẻ em, ' + infantNo + ' sơ sinh';
            $('#viewPassengerInfoContent').html(html);
        }
        else {
            $('#viewPassengerInfoContent #adultLabel').text(adultNo);
            $('#viewPassengerInfoContent #childLabel').text(childNo);
            $('#viewPassengerInfoContent #infantLabel').text(infantNo);
        }
    },

    initStepperChoosePassenger: function () {
        if ($('.btn-plus').length > 0) {
            $('#viewPassengerInfoContent_dropdownContent li[data-passenger="adult"]').find('.step-number').text($('[name="AdultNo"]').val());
            $('#viewPassengerInfoContent_dropdownContent li[data-passenger="child"]').find('.step-number').text($('[name="ChildNo"]').val());
            $('#viewPassengerInfoContent_dropdownContent li[data-passenger="infant"]').find('.step-number').text($('[name="InfantNo"]').val());

            $('.btn-plus').click(function () {
                var step = $(this).closest('li[data-passenger]').find('.step-number').text();
                var stepnum = parseInt(step);
                var max = parseInt($(this).closest('li[data-passenger]').data('max'));
                if (stepnum + 1 <= max) {
                    stepnum++;

                    var paxType = $(this).closest('li[data-passenger]').data('passenger');

                    if (paxType == 'infant' && stepnum > $('[name="AdultNo"]').val()) {
                        return;
                    }

                    $(this).closest('li[data-passenger]').find('.step-number').text(stepnum);

                    if (paxType == 'adult') {
                        $('[name="AdultNo"]').val(stepnum);
                    }
                    else if (paxType == 'child') {
                        $('[name="ChildNo"]').val(stepnum);
                    }
                    else if (paxType == 'infant') {
                        $('[name="InfantNo"]').val(stepnum);
                    }

                    share.flight_search_dialog.updatePaxInfo();
                }
            });

            $('.btn-minus').click(function () {
                var step = $(this).closest('li[data-passenger]').find('.step-number').text();
                var stepnum = parseInt(step);
                var min = parseInt($(this).closest('li[data-passenger]').data('min'));
                if (stepnum - 1 >= min) {
                    stepnum--;

                    var paxType = $(this).closest('li[data-passenger]').data('passenger');

                    if (paxType == 'adult' && stepnum < $('[name="InfantNo"]').val()) {
                        return;
                    }
                    $(this).closest('li[data-passenger]').find('.step-number').text(stepnum);

                    if (paxType == 'adult') {
                        $('[name="AdultNo"]').val(stepnum);
                    }
                    else if (paxType == 'child') {
                        $('[name="ChildNo"]').val(stepnum);
                    }
                    else {
                        $('[name="InfantNo"]').val(stepnum);
                    }

                    share.flight_search_dialog.updatePaxInfo();
                }
            });
        }
    },

    load: function () {
        if ($('#EnableShowLowestPriceOnSearchBox').val() != undefined) {
            if ($('#EnableShowLowestPriceOnSearchBox').val() != null && $('#EnableShowLowestPriceOnSearchBox').val() == 'true')
                share.flight_search_dialog.enableShowLowestPriceOnSearchBox = true;
        }
        var theme = $('#Theme').val();

        $("input[name=JourneyType]:radio").on("change", function () {

            if (theme != 'Globalink' && theme != 'HongNgocHa' && theme != 'HongNgocHa_V2') {

                if ($(this).is(':checked') && $(this).attr('id') === 'radioOneWay') {
                    $('#returnDate').attr('disabled', 'disabled');
                    $('#returnDate').val('');
                } else
                    $('#returnDate').removeAttr('disabled');
            } else if (theme == 'HongNgocHa' || theme == 'HongNgocHa_V2') {
                if ($(this).is(':checked') && $(this).attr('id') === 'radioOneWay') {
                    $('#returnDate').attr('disabled', 'disabled');
                } else
                    $('#returnDate').removeAttr('disabled');
            }
        });

        initLocationCookie(theme);

        $('.mooncalendar').bind('click', function () {
            //var win = window.open('http://www.informatik.uni-leipzig.de/~duc/amlich/PHP/index.php', 'Tra cứu lịch âm', 'width=500,height=550');
            $('#popup')
                .html("<iframe src='http://www.informatik.uni-leipzig.de/~duc/amlich/PHP/index.php\' width='500' height='600'></iframe>")
                .dialog(
                    {
                        title: 've24h.vn',
                        width: 550,
                        height: 600,
                        modal: true
                    }).dialog("open");
        });

        $('.dateicon').bind('click', function () {
            var $input = $(this).prev();
            if ($input.attr('disabled') !== 'disabled')
                $input.datepicker('show');
        });

        $('#flightSearchForm').submit(function (event) {

            var msg = '';
            var success = true;
            var count = 0;
            if ($('#DepartureCity').val() == '') {
                msg += 'Vui lòng chọn điểm khởi hành! <br />';
                success = false;
                count++;
                $('#search-error-dlg').attr('data-error', '1');
            }
            if ($('#ArrivalCity').val() == '') {
                msg += 'Vui lòng chọn điểm đến! <br />';
                success = false;
                if (count == 0) {
                    count = 2;
                    $('#search-error-dlg').attr('data-error', '2');
                }
            }
            if ($('#depatureDate').val() == '') {
                msg += 'Vui lòng chọn ngày đi! <br />';
                success = false;
                if (count == 0) {
                    count = 3;
                    $('#search-error-dlg').attr('data-error', '3');
                }
            }

            if ($('#radioRoundTrip').is(':checked') && ($('#returnDate').val() == 'Ngày về' || $('#returnDate').val() == '')) {
                if (theme != 'Globalink') {
                    msg += 'Vui lòng chọn ngày về! <br />';
                    success = false;
                    if (count == 0) {
                        count = 4;
                        $('#search-error-dlg').attr('data-error', '4');
                    }
                }
            }


            if (parseInt($('select[name="InfantNo"]').val()) > parseInt($('select[name="AdultNo"]').val())) {
                msg += "Số khách em bé nhiều hơn số khách người lớn. Vui lòng chọn lại! <br/>";
                success = false;
                if (count == 0) {
                    count = 5;
                    $('#search-error-dlg').attr('data-error', '5');
                }
            }

            if (!success) {
                event.preventDefault();
                $("#search-error-dlg #errormessage").html(msg);
                //window.dialog.display(msg, 'Error');
                $dialogerorr.dialog('option', 'title', 'Lỗi phát sinh');
                //$dialogerorr.dialog('option', 'position', { my: "left top", at: "left bottom", of: e.target });
                $dialogerorr.dialog('open');
            } else {
                saveLocationCookie();

                $("#search-error-dlg #errormessage").html("");
                $('#search-error-dlg').attr('data-error', '0');
                submitSearchFlightPrettyUrl(event);
            }
        });

        if ($('#btn-switch').length > 0) {
            $('#btn-switch').click(function () {
                share.flight_search_dialog.switchLocations();
            });
        }

        if ($('#viewPassengerInfoContent').length > 0) {
            $('select[name="AdultNo"], select[name="ChildNo"], select[name="InfantNo"]').change(function () {
                share.flight_search_dialog.updatePaxInfo();
            });
            share.flight_search_dialog.updatePaxInfo();
        }

        share.flight_search_dialog.initStepperChoosePassenger();

        function encodeUrlCookie() {
            
            var departureCityHolder = $.cookie('departureCityHolder');
            var arrivalCityHolder = $.cookie('arrivalCityHolder');
            var departureCityCountry = $.cookie('departureCityCountry');
            var arrivalCityCountry = $.cookie('arrivalCityCountry');

            if (departureCityHolder && departureCityHolder.indexOf('%') < 0) {
                $.cookie('departureCityHolder', encodeURI(departureCityHolder), { path: '/' });
            }

            if (arrivalCityHolder && arrivalCityHolder.indexOf('%') < 0) {
                $.cookie('arrivalCityHolder', encodeURI(arrivalCityHolder), { path: '/' });
            }

            if (departureCityCountry && departureCityCountry.indexOf('%') < 0) {
                $.cookie('departureCityCountry', encodeURI(departureCityCountry), { path: '/' });
            }

            if (arrivalCityCountry && arrivalCityCountry.indexOf('%') < 0) {
                $.cookie('arrivalCityCountry', encodeURI(arrivalCityCountry), { path: '/' });
            }
        }

        function initLocationCookie(theme) {
            encodeUrlCookie();

            // Do not save cookie for mobile layout
            if ($('#DepartureCity-Holder').prop('tagName') == 'SELECT')
                return;

            var languageId = $("#LanguageId").val();

            if ($.cookie('departureCity') == null) {
                var theme = $('#Theme').val();

                if (theme == 'VietJet24') {
                    $.cookie('departureCityHolder', encodeURI('Điểm khởi hành (DD)'), { path: '/' });
                }
                else {
                    if (languageId != '' && languageId == 'vi') {
                        $.cookie('departureCityHolder', encodeURI('Hồ Chí Minh (SGN)'), { path: '/' });
                    }
                    else {
                        $.cookie('departureCityHolder', encodeURI('Ho Chi Minh (SGN)'), { path: '/' });
                    }
                }
                $.cookie('departureCity', 'SGN', { path: '/' });
            }

            if ($.cookie('arrivalCity') == null) {
                if (languageId != '' && languageId == 'vi') {
                    $.cookie('arrivalCityHolder', encodeURI('Hà Nội (HAN)'), { path: '/' });
                }
                else {
                    $.cookie('arrivalCityHolder', encodeURI('Ha Noi (HAN)'), { path: '/' });


                }
                $.cookie('arrivalCity', 'HAN', { path: '/' });
            }

            if (theme == 'HongNgocHa' || theme == 'CanhChimViet' || theme == 'HongNgocHa_V2') {
                if ($.cookie('departureCityCountry') == null || $.cookie('departureCityCountry') == '') {
                    if (languageId != '' && languageId == 'vi') {
                        $.cookie('departureCityCountry', encodeURI('Việt Nam'), { path: '/' });
                    }
                    else {
                        $.cookie('departureCityCountry', encodeURI('Viet Nam'), { path: '/' });
                    }
                }
                if ($.cookie('arrivalCityCountry') == null || $.cookie('arrivalCityCountry') == '') {
                    if (languageId != '' && languageId == 'vi') {
                        $.cookie('arrivalCityCountry', encodeURI('Việt Nam'), { path: '/' });
                    }
                    else {
                        $.cookie('arrivalCityCountry', encodeURI('Viet Nam'), { path: '/' });
                    }
                }
            }

            if (theme == 'HongNgocHa' || theme == 'HongNgocHa_V2') {
                $('#DepartureCity-Holder').val(decodeURI($.cookie('departureCityHolder')) + ', ' + decodeURI($.cookie('departureCityCountry')));
                $('#DepartureCity').val($.cookie('departureCity'));
                $('#DepartureCityCountry').val(decodeURI($.cookie('departureCityCountry')));

                $('#ArrivalCity-Holder').val(decodeURI($.cookie('arrivalCityHolder')) + ', ' + decodeURI($.cookie('arrivalCityCountry')));
                $('#ArrivalCity').val($.cookie('arrivalCity'));
                $('#ArrivalCityCountry').val(decodeURI($.cookie('arrivalCityCountry')));
            }
            else {
                $('#DepartureCity-Holder').val(decodeURI($.cookie('departureCityHolder')));
                $('#DepartureCity').val($.cookie('departureCity'));

                $('#ArrivalCity-Holder').val(decodeURI($.cookie('arrivalCityHolder')));
                $('#ArrivalCity').val($.cookie('arrivalCity'));
                if (theme == 'CanhChimViet') {
                    $('#DepartureCityCountry').val(decodeURI($.cookie('departureCityCountry')));
                    $('#ArrivalCityCountry').val(decodeURI($.cookie('arrivalCityCountry')));
                    $('#departure-country').text(decodeURI($.cookie('departureCityCountry')));
                    $('#arrival-country').text(decodeURI($.cookie('arrivalCityCountry')));
                }
            }


            if ($.cookie('journeyType') == null) {
                if (theme == 'SanVeRe')
                    $.cookie('journeyType', '2');
                else
                    $.cookie('journeyType', '1');
            }

            var journeyType = $.cookie('journeyType');

            if (journeyType == 1) {
                $("input[name=JourneyType][value=1]").closest('label[for=radioOneWay]').click();
            }
            else {
                $("input[name=JourneyType][value=2]").closest('label[for=radioRoundTrip]').click();
            }

            //$('#DepartureCity-Holder').val($.cookie('departureCityHolder'));
            //var departureLoc = $('#DepartureCity-Holder').val();
            //var departureLocationId = departureLoc.substring(departureLoc.indexOf('(') + 1, departureLoc.lastIndexOf(')'));
            //$('#DepartureCity').val(departureLocationId);



            // $('#ArrivalCity-Holder').val($.cookie('arrivalCityHolder'));
            //var arrivalLoc = $('#ArrivalCity-Holder').val();
            //var arrivalLocationId = arrivalLoc.substring(arrivalLoc.indexOf('(') + 1, arrivalLoc.lastIndexOf(')'));
            //$('#ArrivalCity').val(arrivalLocationId);

            if ($.cookie('depatureDate') != null) {
                console.log($.cookie('depatureDate'));
                $('#depatureDate').val($.cookie('depatureDate'));
            }
            if (theme != 'Globalink' && $.cookie('returnDate') != null && $.cookie('journeyType') == '2') {
                $('#returnDate').val($.cookie('returnDate'));
            }

            if ($.cookie('adultNo') != null && $.cookie('adultNo') != '') {
                $('#adultNo').val($.cookie('adultNo'));
            } else {
                $('#adultNo').val(1);
            }

            if ($.cookie('childNo') != null && $.cookie('childNo') != '') {
                $('#childNo').val($.cookie('childNo'));
            } else {
                $('#childNo').val(0);
            }
            
            if ($.cookie('infantNo') != null && $.cookie('infantNo') != '') {
                $('#infantNo').val($.cookie('infantNo'));
            } else {
                $('#infantNo').val(0);
            }
        }

        function saveLocationCookie() {
            $.removeCookie('departureCityHolder', { path: '/Booking' });
            $.removeCookie('arrivalCityHolder', { path: '/Booking' });
            $.removeCookie('departureCity', { path: '/Booking' });
            $.removeCookie('arrivalCity', { path: '/Booking' });         
            $.removeCookie('depatureDate', { path: '/Booking' });
            $.removeCookie('returnDate', { path: '/Booking' });
            $.removeCookie('adultNo', { path: '/Booking' });
            $.removeCookie('childNo', { path: '/Booking' });
            $.removeCookie('infantNo', { path: '/Booking' });
            $.removeCookie('journeyType', { path: '/Booking' });
            if (theme == 'HongNgocHa' || theme == 'CanhChimViet' || theme == 'HongNgocHa_V2') {
                $.removeCookie('arrivalCityCountry', { path: '/Booking' });
                $.removeCookie('departureCityCountry', { path: '/Booking' });
            }

            //$.removeCookie('departureCityCountry', { path: '/Booking' });
            //$.removeCookie('arrivalCityCountry', { path: '/Booking' });

            var departureCityHolder = $('#DepartureCity-Holder').val();
            var arrivalCityHolder = $('#ArrivalCity-Holder').val();

            if (departureCityHolder.indexOf('%') < 0) {
                departureCityHolder = encodeURI(departureCityHolder);
            }
            if (arrivalCityHolder.indexOf('%') < 0) {
                arrivalCityHolder = encodeURI(arrivalCityHolder);
            }

            
            $.cookie('departureCityHolder', departureCityHolder, { path: '/' });
            $.cookie('arrivalCityHolder', arrivalCityHolder, { path: '/' });
            $.cookie('departureCity', $('#DepartureCity').val(), { path: '/' });
            $.cookie('arrivalCity', $('#ArrivalCity').val(), { path: '/' });
            $.cookie('depatureDate', $('#depatureDate').val(), { path: '/' });
            $.cookie('returnDate', $('#returnDate').val(), { path: '/' });
            $.cookie('adultNo', $('#adultNo').val(), { path: '/' });
            $.cookie('childNo', $('#childNo').val(), { path: '/' });
            $.cookie('infantNo', $('#infantNo').val(), { path: '/' });
            $.cookie('journeyType', $("input[name='JourneyType']:checked").val(), { path: '/' });

            if (theme == 'HongNgocHa' || theme == 'CanhChimViet' || theme == 'HongNgocHa_V2') {
                var departureCityCountry = $('#DepartureCityCountry').val();
                var arrivalCityCountry = $('#ArrivalCityCountry').val();
                if (departureCityCountry.indexOf('%') < 0) {
                    departureCityCountry = encodeURI(departureCityCountry);
                }
                if (arrivalCityCountry.indexOf('%') < 0) {
                    arrivalCityCountry = encodeURI(arrivalCityCountry);
                }
                $.cookie('departureCityCountry', departureCityCountry, { path: '/' });
                $.cookie('arrivalCityCountry', arrivalCityCountry, { path: '/' });
            }
        }

        function submitSearchFlightPrettyUrl(event) {
            event.preventDefault();
            var departureCity = $('#DepartureCity').val();
            var arrivalCity = $('#ArrivalCity').val();
            var departureDate = $('#depatureDate').val().substring(6, 10) + $('#depatureDate').val().substring(3, 5) + $('#depatureDate').val().substring(0, 2);
            var arrivalDate = $('#returnDate').val().substring(6, 10) + $('#returnDate').val().substring(3, 5) + $('#returnDate').val().substring(0, 2);
            var journeyType = $("input[name='JourneyType']:checked").val() == undefined ? "1" : $("input[name='JourneyType']:checked").val();
            var adultNo = $('#adultNo option:selected').val() == undefined ? "1" : $('#adultNo option:selected').val();
            var childNo = $('#childNo option:selected').val() == undefined ? "0" : $('#childNo option:selected').val();
            var infantNo = $('#infantNo option:selected').val() == undefined ? "0" : $('#infantNo option:selected').val();
            var theme = $('#Theme').val();
            if (theme == 'NamThanh' || theme=="CanhChimViet" || theme == 'HongNgocHa_V2') {
                adultNo = $('#adultNo').val();
                childNo = $('#childNo').val();
                infantNo = $('#infantNo').val();
            }

            /*if (theme == 'NamThanh') {
                var dateNow = new Date();
                var date = new Date(departureDate.substr(0, 4) + "-" + departureDate.substr(4, 2) + "-" + departureDate.substr(6));
                departureDate = Math.round((date - dateNow) / (1000 * 60 * 60 * 24)) + 'D';

                if (journeyType != 1) {
                    date = new Date(arrivalDate.substr(0, 4) + "-" + arrivalDate.substr(4, 2) + "-" + arrivalDate.substr(6));
                    arrivalDate = Math.round((date - dateNow) / (1000 * 60 * 60 * 24)) + 'D';
                }
            }*/

            var paramSearchString = departureCity + "-" + arrivalCity + "-" + departureDate;
            if (journeyType == 1) {
                paramSearchString += '-' + adultNo + childNo + infantNo;
            } else {
                paramSearchString += '-' + arrivalDate + '-' + adultNo + childNo + infantNo;
            }
            var urlSearchString = '/tim-ve-may-bay/' + paramSearchString;
            location.href = urlSearchString;
        }
    
        if ($('.sponsor-holder').length) {
            $('.sponsor-holder').carouFredSel({
                direction: 'right',
                scroll: {
                    items: 1
                },
                duration: 3000
            });
        }

        var choseLocationFromDialog = false;

        var $dialog = $('#departure-location-dlg').dialog(
                {
                    modal: false,
                    autoOpen: false,
                    resizable: true,
                    open: function () {
                        $("body").addClass("open-dialog");
                        if(theme != "SanVeRe")
                            $('#inter-city-departure').focus();
                    },
                    close: function () {
                        $dialog.dialog('close');
                        $("body").removeClass("open-dialog");

                        //****************************************************************************************
                        // Fix bugs: some do not auto popup the next component after selecting current component 
                        //****************************************************************************************
                        var keySearch = $("#UseSearchAutoFocusComponent").val().toLowerCase();
                        if (keySearch == "true") {
                            var mode = $('#departure-location-dlg').attr('data-mode');
                            if (mode == "Departure") {
                                if ($('#DepartureCity-Holder').val() != "Điểm khởi hành") {
                                    //$('#ArrivalCity-Holder').select();
                                    $('#ArrivalCity-Holder').click();
                                } else {
                                    $('#DepartureCity-Holder').focus();
                                }
                            } else {
                                if ($('#ArrivalCity-Holder').val() != "Nơi đến") {
                                    $('#depatureDate').focus();
                                } else {
                                    $('#ArrivalCity-Holder').focus();
                                }
                            }
                        }
                    }
                });
        if (theme == 'CanhChimViet') {
            $('#departure-location-dlg').dialog("option", "modal", true);
        };
        var $dialog_domestic = $('#departure-location-dlg-domestic').dialog(
                {
                    modal: false,
                    autoOpen: false,
                    resizable: true,
                    minWidth: 700,
                    open: function () {
                        $('#inter-city-departure').focus();
                        $("body").addClass("open-dialog");
                    },
                    close: function () {
                        $dialog_domestic.dialog('close');
                        $("body").removeClass("open-dialog");

                        //****************************************************************************************
                        // Fix bugs: some do not auto popup the next component after selecting current component 
                        //****************************************************************************************
                        var keySearch = $("#UseSearchAutoFocusComponent").val().toLowerCase();
                        if (keySearch == "true") {
                            var mode = $('#departure-location-dlg-domestic').attr('data-mode');
                            if (mode == "Departure") {
                                if ($('#DepartureCity-Holder-Domestic').val() != "Điểm khởi hành") {
                                    $('#ArrivalCity-Holder').select();
                                } else {
                                    $('#DepartureCity-Holder-Domestic').focus();
                                }
                            } else {
                                if ($('#ArrivalCity-Holder').val() != "Nơi đến") {
                                    $('#depatureDate').focus();
                                } else {
                                    $('#ArrivalCity-Holder').focus();
                                }
                            }
                        }
                    }
                });

        var $dialogerorr = $('#search-error-dlg').dialog(
                {
                    modal: false,
                    width: 300,
                    autoOpen: false,
                    resizable: false,
                    open: function () {

                    },
                    close: function () {
                        $dialogerorr.dialog('close');
                        var count = $('#search-error-dlg').attr('data-error');
                        switch (count) {
                            case '1':
                                $('#DepartureCity-Holder').focus();
                                break;
                            case '2':
                                $('#ArrivalCity-Holder').focus();
                                break;
                            case '3':
                                $('#depatureDate').focus();
                                break;
                            case '4':
                                $('#returnDate').focus();
                                break;
                        }
                    }
                });
        if (theme == 'CanhChimViet') {
            $('#search-error-dlg').dialog("option", "modal", true);
        };

        $('#DepartureCity-Holder').bind('click', function (e) {
            $('.location-link').each(function () {
                $(this).show();
            });
            var theme = $('#Theme').val();
            //$('#inter-city-departure').val($('#DepartureCity-Holder').val());
            //$("#inter-city-departure").attr('data-locationId', $('#DepartureCity').val());

            if (theme == 'LienLucDia') {

                $('.location-link-domestic').each(function () {
                    $(this).show();
                });

                $('#departure-location-dlg-domestic').attr('data-mode', 'Departure');
                var dataTitleDeparture = $('#departure-location-dlg-domestic').attr('data-title-departure');
                $dialog_domestic.dialog('option', 'title', dataTitleDeparture);
                $dialog_domestic.dialog('option', 'width', 180);
                $dialog_domestic.dialog('option', 'height', 550);
                $dialog_domestic.dialog({ resizable: false, draggable: false });
                assignDialogSize($dialog_domestic);
                $('#departure-location-dlg-domestic').parents().css("max-height", "150px");
                $dialog_domestic.dialog('option', 'position', { my: "left top", at: "left bottom", of: e.target });
               
                $('#departure-location-dlg-domestic').attr('data-id', this.id);
                loadLocationByFlightConnection($("#DepartureCity").val());
                $dialog_domestic.dialog('open');
            }
            else {
                $('#departure-location-dlg').attr('data-mode', 'Departure');
                var dataTitleDeparture = $('#departure-location-dlg').attr('data-title-departure');
                $dialog.dialog('option', 'title', dataTitleDeparture);
                assignDialogSize($dialog);
                $dialog.dialog('option', 'position', { my: "left top", at: "left bottom", of: e.target });
                $('#departure-location-dlg').attr('data-id', this.id);

                if ($('#IsUseInternationalAndDometicTab').val() != undefined && $('#IsUseInternationalAndDometicTab').val().toLowerCase() == "true") {
                   
                    ShowInternationalOrDomesticLocation();
                }
                
                $dialog.dialog('open');
            }
        });

        $('#ArrivalCity-Holder').bind('click', function (e) {
            $('.location-link').each(function () {
                $(this).show();
            });

            var theme = $('#Theme').val();
            
            //$('#inter-city-departure').val($('#ArrivalCity-Holder').val());
            //$("#inter-city-departure").attr('data-locationId', $('#ArrivalCity').val());

            if (theme == 'LienLucDia') {

                $('.location-link-domestic').each(function () {
                    $(this).show();
                });
            }

            var departureCity = $('#DepartureCity').val();
            var parentId = [];
            if ($("#filter-arrival-location").val().toLowerCase() == 'true') {
                var flightConnection = [];
                $('#FlightConnection > option').each(function () {
                    var fconnection = $(this).val();
                    if (fconnection == departureCity) {
                        flightConnection.push($(this).text());
                    }
                });

                $('.location-link').each(function () {
                    var locationId = $(this).attr('data-code');
                    var flag = false;
                    for (var i = 0; i < flightConnection.length; i++) {
                        if (locationId == flightConnection[i]) {
                            flag = true;
                            break;
                        }
                    }
                    if (flag == false) {
                        $(this).hide();
                    } else {
                        $(this).show();
                    }
                });
                if (theme == 'LienLucDia') {
                    $('.location-link-domestic').each(function () {
                        var locationId = $(this).attr('data-code');
                        var flag = false;
                        for (var i = 0; i < flightConnection.length; i++) {
                            if (locationId == flightConnection[i]) {
                                flag = true;
                                break;
                            }
                        }
                        if (flag == false) {
                            $(this).hide();
                        } else {
                            $(this).show();
                        }
                    });
                }

            }

            // Remove selected departure city out of arrival list
            $('.location-link').each(function () {
                var locationId = $(this).attr('data-code');
                if (locationId == departureCity) {
                    $(this).hide();
                }
                else {
                    parentId.push($(this).attr('data-parentid'));
                }
            });
            $('.countryTitle').each(function () {
                var flag = false;
                var id = $(this).attr('data-parentid');
                for (var i = 0; i < parentId.length; i++) {
                    if (parentId[i] == id) {
                        flag = true;
                    }
                }
                if (flag == false) {
                    $(this).hide();
                }
                //else {
                //    $(this).show();
                //}
            });
            $('#departure-location-dlg').attr('data-mode', 'Arrival');
            var dataTitleArrival = $('#departure-location-dlg').attr('data-title-arrival');
            $dialog.dialog('option', 'title', dataTitleArrival);
            assignDialogSize($dialog);
            $dialog.dialog('option', 'position', { my: "left top", at: "left bottom", of: e.target });
            $('#departure-location-dlg').attr('data-id', this.id);
            if (theme == "LienLucDia")
            {
                $('#departure-location-dlg').parents().css("max-height", "150px");
                $dialog.dialog({ resizable: false, draggable: false });
            }
            if ($('#IsUseInternationalAndDometicTab').val() != undefined && $('#IsUseInternationalAndDometicTab').val().toLowerCase() == "true") {
                ShowInternationalOrDomesticLocation();
            }

            $dialog.dialog('open');
        });
        function ShowInternationalOrDomesticLocation()
        {
            var isDemostic = $("input[name='FlightType']:checked").val().toLowerCase();
            if (isDemostic == "true") {
                $dialog.dialog('option', 'width', $('#search-dialog-domestic-width').val());
                $('#international-location').hide();
                $('#domestic-locaiton').show();
            }
            else {
                $dialog.dialog('option', 'width', $('#search-dialog-international-width').val());
                $('#international-location').show();
                $('#domestic-locaiton').hide();
            }
        }
        function loadLocationByFlightConnection(_depatureCity) {
            var theme = $('#Theme').val();
            var departureCity = _depatureCity;
            if (theme == 'LienLucDia') {
                var flightConnection = [];
                $('#FlightConnection > option').each(function () {
                    var fconnection = $(this).val();
                    if (fconnection == departureCity) {
                        flightConnection.push($(this).text());
                    }
                });
                var parentId = [];
                $('.location-link').each(function () {
                    var locationId = $(this).attr('data-code');
                    var flag = false;
                    for (var i = 0; i < flightConnection.length; i++) {
                        if (locationId == flightConnection[i]) {
                            flag = true;
                            break;
                        }
                    }
                    if (flag == false) {
                        $(this).hide();
                    } else {
                        parentId.push($(this).attr('data-parentid'));
                        $(this).show();
                    }
                });
                $('.countryTitle').each(function () {
                    var flag = false;
                    var id = $(this).attr('data-parentid');
                    for (var i = 0; i < parentId.length; i++) {
                        if (parentId[i] == id) {
                            flag = true;
                        }
                    }
                    if (flag == false) {
                        $(this).hide();
                    }
                    else {
                        $(this).show();
                    }
                });
            }
        }

        function assignDialogSize(dialog) {
            if (getSearchDialogWidth() > 0) {
                dialog.dialog('option', 'width', getSearchDialogWidth());
            }
            if (getSearchDialogHeight() > 0) {
                dialog.dialog('option', 'height', getSearchDialogHeight());

            }

        }

        function getSearchDialogWidth() {
            if ($('#FullSearchDialog') != null && $('#FullSearchDialog').val() == '1') {
                if ($('#international-search-dialog-width') != null) {
                    return $('#international-search-dialog-width').val();
                }
            } else {
                if ($('#search-dialog-width') != null)
                    return $('#search-dialog-width').val();
            }

            return 0;
        }

        function getSearchDialogHeight() {
            if ($('#FullSearchDialog') != null && $('#FullSearchDialog').val() == '1') {
                if ($('#international-search-dialog-height') != null)
                    return $('#international-search-dialog-height').val();
            } else {
                if ($('#search-dialog-height') != null)
                    return $('#search-dialog-height').val();
            }

            return 0;
        }

        var thisDay = new Date();
        var monthOfCalendar = thisDay.getMonth() + 1;
        var yearOfCalendar = thisDay.getFullYear();
        var dates = $("#depatureDate, #returnDate").datepickerlunar({
            dateFormat: 'dd/mm/yy',
            defaultDate: "+0d",
            changeMonth: false,
            //numberOfMonths: displayNumberOfMonth,
            minDate: 0,
            autoclose: true,
            onSelect: function (selectedDate) {
                var selectedDate = $(this).val();
                var option = this.id == "depatureDate" ? "minDate" : "maxDate",
                    instance = $(this).data("datepickerlunar");
                var date = $.datepickerlunar.parseDate(
                    instance.settings.dateFormat ||
                        $.datepicker._defaults.dateFormat,
                    selectedDate, instance.settings);
                monthOfCalendar = date.getMonth() + 1;
                yearOfCalendar = date.getFullYear();
                if (this.id == "depatureDate") {
                    $("#returnDate").datepickerlunar("option", 'minDate', date);

                    if ($("input[name='JourneyType']:checked").val() == '1') {

                        $("#returnDate").val('Ngày về');
                    }
                }
                else {
                    $("#depatureDate").datepickerlunar("option", 'maxDate', date);
                }
                //************************************************************************************
                // Fix bugs: some do not auto popup the next component after selecting current component 
                //************************************************************************************
                var focusvalue = $('#ui-datepicker-div').attr('data-date-mode');
                var keySearch = $("#UseSearchAutoFocusComponent").val().toLowerCase();
                if (keySearch == "true") {

                    if (focusvalue == "depaturedatefocus") {
                        $("body").removeClass("open-dialog");
                        if ($("input[name='JourneyType']:checked").val() == '2') {
                            $('#returnDate').focus();
                        }
                    }
                    else {
                        $('#ui-datepicker-div').hide();
                        $("body").removeClass("open-dialog");
                    }

                    if (theme == 'HongNgocHa' && focusvalue != 'depaturedatefocus') {
                        if ($("input[name='JourneyType']:checked").val() == '1') {
                            $('#returnDate').focus();
                            $('label[for=radioRoundTrip]').click();//lam cach nao de ko chay lai cai su kien click

                        }
                    }
                }
            },
            onChangeMonthYear: function (year, month, inst) {
                monthOfCalendar = month;
                yearOfCalendar = year;
                if (share.flight_search_dialog.enableShowLowestPriceOnSearchBox)
                    showLowestPriceInCalendar(this.id == "depatureDate" ? true : false);

            }
        });

        $('#depatureDate').on('focus', function (e) {
            $("body").addClass("open-dialog");
            $('#ui-datepicker-div').attr('data-date-mode', 'depaturedatefocus');
        });
        $('#depatureDate').on('click', function (e) {
            //monthOfCalendar = thisDay.getMonth() + 1;
            if (share.flight_search_dialog.enableShowLowestPriceOnSearchBox) {
                showLowestPriceInCalendar(true);
            }

        });

        $('#returnDate').on('focus', function (e) {
            //if (theme != 'HongNgocHa') {
            $("body").addClass("open-dialog");
            $('#ui-datepicker-div').attr('data-date-mode', 'returndatefocus');
            //}
        });
        $('#returnDate').on('click', function (e) {
            //monthOfCalendar = thisDay.getMonth() + 1;
            if (share.flight_search_dialog.enableShowLowestPriceOnSearchBox) {
                showLowestPriceInCalendar(false);
            }
        });
        /*$('#returnDate').change( function (e) {
            
        });*/
        function showLowestPriceInCalendar(isDepartureDate) {
            let departureCity = $("#DepartureCity").val();
            let arrivalCity = $("#ArrivalCity").val();
            if (isDepartureDate == false) {
                departureCity = $("#ArrivalCity").val();
                arrivalCity = $("#DepartureCity").val();
            }
            var lastDayOfMonth = new Date(yearOfCalendar, monthOfCalendar, 0);
            let fromDate = monthOfCalendar + "/" + 1 + "/" + yearOfCalendar; // new Date(today.getFullYear(), month, $(calendarDays[0]).html());
            let toDate = monthOfCalendar + "/" + lastDayOfMonth.getDate() + "/" + yearOfCalendar; //new Date(today.getFullYear(), month, $(calendarDays[calendarDays.length - 1]).html());
            let url = "/PopulateCategory/GetFlightLowestPrice";
            var datasend = {
                depatureCity: departureCity,
                arrivalCity: arrivalCity,
                fromDate: fromDate,
                toDate: toDate
            };

            $.ajax({
                type: "GET",
                url: url,
                data: datasend,
                contentType: "application/json",
                success: function (response) {
                    let currentCalendarDays = $('.ui-datepicker-day');
                    if (response.length > 0) {
                        response.forEach(function (item) {
                            let departureDateData = new Date(item.DepartureDate);

                            let dayHasLowestPrice = currentCalendarDays.toArray().filter(x => $(x).html() == departureDateData.getDate());
                            if (dayHasLowestPrice.length > 0) {
                                let price = item.Price + '';
                                if (price.length > 4) {
                                    if (price.endsWith("000")) {
                                        let index = price.lastIndexOf("000");
                                        price = price.substr(0, index) + 'K';
                                    }
                                }
                                let flightPriceHtml = `<span class='price-in-calendar'>${price}</span>`;
                                $(dayHasLowestPrice[0]).parent().parent().append(flightPriceHtml);
                            }
                        });
                    }
                }
            });
        }
        /*dates.change(function (selectedDate) {
            var selectedDate = $(this).val();
            var option = this.id == "depatureDate" ? "minDate" : "maxDate",
                    instance = $(this).data("datepickerlunar");
            var date = $.datepickerlunar.parseDate(
                instance.settings.dateFormat ||
                    $.datepicker._defaults.dateFormat,
                selectedDate, instance.settings);
            dates.not(this).datepickerlunar("option", option, date);

            
        });*/

        $('#ui-datepicker-div').bind('mouseleave', function (e) {
            //$('#ui-datepicker-div').hide();
        });

        var theme = $('#Theme').val();
        $('.location-link-domestic').bind('click', function () {
            var element = $('#departure-location-dlg-domestic').attr('data-id');
            $('#' + element).val($(this).attr('data-val'));
            var valuedElement = element.split('-')[0];
            $('#' + valuedElement).val($(this).attr('data-code'));
            $dialog_domestic.dialog('close');
            loadLocationByFlightConnection($("#DepartureCity").val());
        });

        $('.location-link').bind('click', function () {
            
            var element = $('#departure-location-dlg').attr('data-id');
            $('#' + element).val($(this).attr('data-val'));
            var valuedElement = element.split('-')[0];
            $('#' + valuedElement).val($(this).attr('data-code'));

            if (theme == 'HongNgocHa' || theme == 'CanhChimViet' || theme == 'HongNgocHa_V2') {
                var dataMode = $('#departure-location-dlg').attr('data-mode');
                if (dataMode == 'Departure') {
                    $("#DepartureCityCountry").val($(this).attr('data-country'));
                    if(theme=='CanhChimViet')
                        $("#departure-country").text($(this).attr('data-country'));
                }
                if (dataMode == 'Arrival') {
                    $("#ArrivalCityCountry").val($(this).attr('data-country'));
                    if (theme == 'CanhChimViet')
                        $("#arrival-country").text($(this).attr('data-country'));
                }
            }
            $dialog.dialog('close');
        });
        
        if (theme == 'CanhChimViet' || theme=='CanhChimViet') {
            $('#inter-city-departure').bind('change', function (event) {
                $(this).attr('data-locationId', $(this).val());
                var dataMode = $('#departure-location-dlg').attr('data-mode');
                if (dataMode == 'Departure') {
                    $("#DepartureCityCountry").val($("#selectCountry option:selected").text());
                    $("#departure-country").text($("#selectCountry option:selected").text());
                }
                if (dataMode == 'Arrival') {
                    $("#ArrivalCityCountry").val($("#selectCountry option:selected").text());
                    $("#arrival-country").text($("#selectCountry option:selected").text());
                }
            });
        }
        else
        {
            $("#inter-city-departure").autocomplete({
                delay: 100,
                //source: '/Home/SearchLocation',
                source: function (request, response) {
                    $("#inter-city-departure").attr('data-locationId', '');
                    $.ajax({
                        url: '/Home/SearchLocation',
                        type: 'GET',
                        data: {
                            term: request.term,
                        },
                        success: function (data) {
                            response(data);
                        }
                    });
                },
                select: function (event, ui) {
                    console.log(ui);
                    $("#inter-city-departure").val(ui.item.label);
                    $("#inter-city-departure").attr('data-locationId', ui.item.value);
                    choseLocationFromDialog = true;

                    chooseLocation();
                    return false;
                },

            });
            $("#inter-city-departure-text").autocomplete({
                delay: 100,
                source: '/Home/SearchLocation',
                select: function (event, ui) {
                    $("#inter-city-departure").val(ui.item.label);
                    $("#inter-city-departure-text").val(ui.item.label);
                    choseLocationFromDialog = true;
                    return false;
                },
            });

            $('#inter-city-departure').bind('keydown', function (event) {

                if (event.which == 13 || event.keyCode == 13) {
                    var location = $('#inter-city-departure');
                    var loc = location.val();

                    if (loc.length > 0 && choseLocationFromDialog) {
                        var element = $('#departure-location-dlg').attr('data-id');

                        $('#' + element).val(loc);
                        var valuedElement = element.split('-')[0];
                        var locationId = loc.substring(loc.indexOf('(') + 1, loc.lastIndexOf(')'));
                        $('#' + valuedElement).val(locationId);
                        //('#inter-city-departure').val('');

                    }

                    $dialog.dialog('close');
                }
            });
        }

        function chooseLocation() {
            var theme = $('#Theme').val();
            var locationIdDialog = $("#inter-city-departure").attr('data-locationId');
            if (!locationIdDialog) {
                return;
            }
            var location = $('#inter-city-departure');
            var loc = location.val();
            //if (location.prop('tagName') == 'SELECT') {
            if (loc == null || loc == '-1' || loc == '')
                return;
            //loc = $('#inter-city-departure option:selected').text();
            choseLocationFromDialog = true;
            //}
            if (loc.length > 0 && choseLocationFromDialog) {
                var element = $('#departure-location-dlg').attr('data-id');
                var valuedElement = element.split('-')[0];
                
                if (valuedElement == 'DepartureCity') {
                    if ($("#inter-city-departure").attr('data-locationId') == $('#ArrivalCity').val()) {
                        $("#search-error-dlg #errormessage").html("Không được chọn sân bay giống nhau. Vui lòng chọn sân bay khác!");
                        $dialogerorr.dialog('option', 'title', 'Lỗi phát sinh');
                        $dialogerorr.dialog('open');
                        return;
                    }
                } else if (valuedElement == 'ArrivalCity') {
                    if ($("#inter-city-departure").attr('data-locationId') == $('#DepartureCity').val()) {
                        $("#search-error-dlg #errormessage").html("Không được chọn sân bay giống nhau. Vui lòng chọn sân bay khác!");
                        $dialogerorr.dialog('option', 'title', 'Lỗi phát sinh');
                        $dialogerorr.dialog('open');
                        return;
                    }
                }
                //var locationId = loc.substring(loc.indexOf('(') + 1, loc.lastIndexOf(')'));
                $('#' + element).val(loc);
                var locationId = location.val();
                var locationCountry = '';
                if (theme == 'CanhChimViet' || theme == 'CanhChimViet') {
                    locationId = location.val();
                    locationCountry = $('#inter-city-departure option:selected').text();
                    $('#' + valuedElement + '-Holder').val(locationCountry);
                } else {
                    locationId = location.attr('data-locationId');
                    locationCountry = loc.substring(loc.indexOf(',') + 1);
                }

                $('#' + valuedElement).val(locationId);
                $('#inter-city-departure').val('');
                $('#' + valuedElement + 'Country').val(locationCountry);
            }
            $dialog.dialog('close');
        }


        $('#btnChooseLocation').bind('click', function () {
                chooseLocation();
            });


        $('.show-detail-flight').bind('click', function () {
            var $link = $(this);
            $('#DepartureCity').val($link.attr('data-departure-code'));
            $('#ArrivalCity').val($link.attr('data-arrival-code'));
            $('#adultNo').val(1);
            $('#childNo #infantNo').val(0);
            $('#depatureDate').val($link.attr('data-date'));
            $('#radioOneWay').click();
            $('#IsDetailAction').val(true);
            $('form').submit();
        });

        $('#btnSentEmail').bind('click', function () {
            var email = $('#emailCustomer').val();
            var validationResult = share.flight_search_dialog.validatesentmail();
            if (!validationResult) {
                var msg = "Nhập Email không đúng định dạng!";
                window.dialog.display(msg, 'Error');
                return false;
            } else {
                var url = "/Home/SaveEmailRegistration";
                var datasend = {
                    Email: email
                };

                $.ajax({
                    type: "POST",
                    url: url,
                    data: JSON.stringify(datasend),
                    dataType: "json",
                    contentType: "application/json;charset=utf-8",
                    success: function (response) {
                        if (response.Success) {
                            window.dialog.display("Đăng ký Email thành công!", 'Thông báo');
                        } else {
                            window.dialog.display("Đăng ký Email không thành công!", 'Lỗi phát sinh');
                        }
                    },
                    complete: function () {
                        $.unblockUI();
                    }
                });
            }
        });

    },

    showNoteYearOldArticle: function (articleId) {
        //
        var $dialogNoteYearOld = $('#NoteYearOldDialog').dialog({
            title: '',
            close: function () {
                $dialogNoteYearOld.dialog("destroy");
            },
            modal: true,
            autoOpen: false,
            width: 520
        });
        $dialogNoteYearOld.dialog('open');
        $('#YearOldDialogCondition').addClass('hide');
        $('#YearOldDialogConditionContent').text('');
        $.ajax({
            url: '/Home/GetNoteYearOldArticle',
            type: 'POST',
            data: {
                articleId: articleId
            },
            //contentType: 'application/json; charset=UTF-8',
            success: function (response) {
                if (response.HasData) {
                    $('#YearOldDialogCondition').removeClass('hide');
                    $('#YearOldDialogConditionContent').html(response.Content);
                }
            }
        });
    }

})